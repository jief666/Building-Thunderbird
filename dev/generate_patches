#!/bin/bash
GENERATE_PATCHES_SCRIPT_ABS_FILENAME=`perl -e 'use Cwd "abs_path";print abs_path(shift)' "${BASH_SOURCE[0]:-${(%):-%x}}"`
GENERATE_PATCHES_SCRIPT_DIR=`dirname "$GENERATE_PATCHES_SCRIPT_ABS_FILENAME"`
#to copy/paste cmds in terminal (for debug purpose?), do this before : GENERATE_PATCHES_SCRIPT_DIR=$(pwd)

function do_it()
{

    cd "$GENERATE_PATCHES_SCRIPT_DIR"/.. # that way, we're in the same cwd as "Build On MacOS..." scripts

    . ./"Build on macOS env" # be careful, this script will define a SCRIPT_DIR var

    mkdir -p ./tmp

    if ! [ -d ./tmp/thunderbird-$THUNDERBIRD_VERSION-origin ]
    then
        if ! [ -f "$OFFLINE_DIR"/thunderbird-$THUNDERBIRD_VERSION.source.tar.xz ]
        then
            mkdir -p offline
	    curl -f https://archive.mozilla.org/pub/thunderbird/releases/$THUNDERBIRD_VERSION/source/thunderbird-$THUNDERBIRD_VERSION.source.tar.xz -o "$OFFLINE_DIR"/thunderbird-$THUNDERBIRD_VERSION.source.tar.xz  ||  return 1
        fi
        mkdir ./tmp/thunderbird-$THUNDERBIRD_VERSION-origin
        tar xzf "$OFFLINE_DIR"/thunderbird-$THUNDERBIRD_VERSION.source.tar.xz --strip-components 1 -C ./tmp/thunderbird-$THUNDERBIRD_VERSION-origin  ||  return 1
    fi


    cd ./tmp/thunderbird-$THUNDERBIRD_VERSION-origin || return 1
    find_dir="."
    #find_dir="./comm" # finding in comm only is quicker, handy for debugging
    #find_dir="./comm/mail/base" # debug

    if ! [ $find_dir == "." ]
    then
        echo ATTENTION : root dir is set to \'$find_dir\' ; Some modified files might not be found
    else
        echo "Finding modified files"
        echo "  ignored files are "
        echo "    - ./comm/mail/installer/package-manifest.in    because this is patched by "Build on macOS" script"
        echo "    - ./servo/components/style/lib.rs              because this is patched by "Build on macOS" script"
        echo "    - ./servo/components/style_traits/lib.rs       because this is patched by "Build on macOS" script"
        echo "    - ./mozconfig-debug                            because this is generated by "Build on macOS" script"
        echo "    - ./mozconfig-release                          because this is generated by "Build on macOS" scrip"
        echo "    - **/_psutil_osx.o                             because it's a binary and seems to be generated by Thunderbird build process"
        echo "    - **/_psutil_posix.o                           because it's a binary and seems to be generated by Thunderbird build process"
        echo "    - **/temp.macosx-10.13-x86_64-2.7              because it seems to be generated by Thunderbird build process"
        echo "    - ./js/src/old-configure                       because it seems to be generated by Thunderbird build process"
    fi
    echo patches.txt will be found in "$GENERATE_PATCHES_SCRIPT_DIR"/patches.txt
    find "$find_dir" \
        \( -regex '*.pyc' \
           -o -path "./comm/mail/installer/package-manifest.in" \
           -o -path "./servo/components/style/lib.rs" \
           -o -path "./servo/components/style_traits/lib.rs" \
           -o -path "./mozconfig-debug" \
           -o -path "./mozconfig-release" \
           -o -name "_psutil_osx.o" \
           -o -name "_psutil_posix.o" \
           -o -name "temp.macosx-10.13-x86_64-2.7" \
           -o -path "./js/src/old-configure" \
           -prune \) \
        -o -type f -exec bash -c 'diff -uN "${1}" "../../thunderbird-$THUNDERBIRD_VERSION/$1"' - {} {} \; > "$GENERATE_PATCHES_SCRIPT_DIR"/patches.txt

}

do_it "$@"
